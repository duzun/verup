#!/usr/bin/env node
var path=require("path"),fs=require("fs"),ver_reg=[/^((?:\$|(?:\s*\**\s*@)|(?:\s*(?:var|,)?\s+))version[\s\:='"]+)([0-9]+(?:\.[0-9]+){2,2})/i,/^(\s*const\s+VERSION[\s='"]+)([0-9]+(?:\.[0-9]+){2,2})/i,/^(\s?\*.*v)([0-9]+(?:\.[0-9]+){2,2})/],json_ver_reg=/^(\s*['"]version['"]\s*\:\s*['"])([0-9]+(?:\.[0-9]+){2,2})/i,bump="1",name="",_a="b";process.argv.forEach(function(a,d){if(!(2>d))if("-"==a.slice(0,1)&&isNaN(parseFloat(a)))_a=a.slice(1);else{switch(_a){case "b":bump=a;break;case "n":name=a}_a="b"}});
var packFile=findPackage(__dirname,name);packFile||(console.log("package.json file not found"),process.exit(1));var _root=path.dirname(packFile),packo=require(packFile);packo||(console.error("Can't read package.json file"),process.exit(1));var _verup=packo.extra&&packo.extra.verup||packo.verup;_verup||(console.log("package.json doesn't have a `verup` property defined"),process.exit(1));var files=_verup.files;_verup.regs&&(ver_reg=_verup.regs.map(function(a){return new RegExp(a,"i")}));var over=packo.version;
if(over){for(var bump=bump.split(".").reverse(),nver=over.split(".").reverse(),b,l;bump.length&&!(b=parseInt(bump.pop())););l=bump.length;nver[l]=+nver[l]+b;bump.forEach(function(a,d){nver[d]=a});nver=nver.reverse().join(".");packo.version=nver;console.log("Bumping version: "+over+" -> "+nver);var buf=JSON.stringify(packo,null,2);buf&&over!=nver&&(buf+="\n",fs.writeFileSync(packFile,buf));var ver_reg_rep=function(a,d){return d+nver};files.forEach(function(a){var d=path.join(_root,a),e=fs.readFileSync(d,
"utf8"),c;switch(path.extname(a)){case ".json":try{var f=JSON.parse(e);f.version=nver;(c=JSON.stringify(f,null,2))&&(c+="\n")}catch(g){c=e.split("\n").map(function(a){return json_ver_reg.test(a)?a.replace(json_ver_reg,ver_reg_rep):a}).join("\n")}break;default:c=e.split("\n").map(function(a){for(var c=ver_reg.length;c--;)if(ver_reg[c].test(a))return a.replace(ver_reg[c],ver_reg_rep);return a}).join("\n")}c&&c!=e&&(console.log("\t"+d.replace(_root,"").replace(/^[\\/]+/,"")),fs.writeFileSync(d,c))})}
function findPackage(a,d){var e=a||".",c;do{c=path.join(e,"package.json");if(fs.existsSync(c)){var f=require(c);if(d){if(f&&f.name==d)return c}else if(!f||"verup"!=f.name)return c}a=e;e=path.join(e,"..")}while(e!=a&&".."!=a.slice(0,2));return!1};