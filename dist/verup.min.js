#!/usr/bin/env node
(function(){function n(b,k){process.stderr.write(b+"\n");process.exit(k)}function u(b,k){var c=b||".";do{var d=g.join(c,"package.json");if(h.existsSync(d)){g.isAbsolute(d)||(d=h.realpathSync(d));var a=p(d);if(k){if(a&&a.name==k)return d}else if(!a||"verup"!=a.name)return d}b=c;c=g.join(c,"..")}while(c!=b&&".."!=b.slice(0,2));return!1}var g=require("path"),h=require("fs"),p=require;try{p=require("require-json5")}catch(b){}var l=[/^((?:\$|(?:\s*\**\s*@)|(?:\s*(?:var|,)?\s+))version[\s:='"]+)([0-9]+(?:\.[0-9]+){2,2})/i,
/^(\s*(?:export\s+)const\s+VERSION[\s='"]+)([0-9]+(?:\.[0-9]+){2,2})/i,/^(\s?\*.*v)([0-9]+(?:\.[0-9]+){2,2})/],v=/^(\s*['"]version['"]\s*:\s*['"])([0-9]+(?:\.[0-9]+){2,2})/i,f="1",q="",r="b";process.argv.forEach(function(b,c){if(!(2>c))if("-"==b.slice(0,1)&&isNaN(parseFloat(b)))r=b.slice(1);else{switch(r){case "b":f=b;break;case "n":q=b}r="b"}});var m=u(process.cwd(),q)||u(__dirname,q);m||n("package.json file not found",1);var w=g.dirname(m),a=p(m);a||n("Can't read package.json file",2);var e=a.extra&&
a.extra.verup||a.verup;e||n("package.json doesn't have a `verup` property defined",3);var z=e.files;e.regs&&(l=e.regs.map(function(b){return new RegExp(b,"i")}));if(e=a.version){f=f.split(".").reverse();for(var c=e.split(".").reverse(),x,t;f.length&&!(x=parseInt(f.pop())););t=f.length;c[t]=+c[t]+x;f.forEach(function(b,a){c[a]=b});c=c.reverse().join(".");a.version=c;console.log("Bumping version: "+e+" -> "+c);(a=JSON.stringify(a,null,2))&&e!=c&&h.writeFileSync(m,a+"\n");var y=function(b,a){return a+
c};z.forEach(function(b){var a=g.join(w,b),e=h.readFileSync(a,"utf8"),d;switch(g.extname(b)){case ".json":try{var f=JSON.parse(e);f.version=c;(d=JSON.stringify(f,null,2))&&(d+="\n")}catch(A){d=e.split("\n").map(function(a){return v.test(a)?a.replace(v,y):a}).join("\n")}break;default:d=e.split("\n").map(function(a){for(var b=l.length;b--;)if(l[b].test(a))return a.replace(l[b],y);return a}).join("\n")}d&&d!=e&&(console.log("\t"+a.replace(w,"").replace(/^[\\/]+/,"")),h.writeFileSync(a,d))})}})();
