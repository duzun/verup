#!/bin/env node
(function(){function n(b,g){process.stderr.write(b+"\n");process.exit(g)}var h=require("path"),k=require("fs"),l=[/^((?:\$|(?:\s*\**\s*@)|(?:\s*(?:var|,)?\s+))version[\s:='"]+)([0-9]+(?:\.[0-9]+){2,2})/i,/^(\s*const\s+VERSION[\s='"]+)([0-9]+(?:\.[0-9]+){2,2})/i,/^(\s?\*.*v)([0-9]+(?:\.[0-9]+){2,2})/],r=/^(\s*['"]version['"]\s*:\s*['"])([0-9]+(?:\.[0-9]+){2,2})/i,f="1",t="",p="b";process.argv.forEach(function(b,g){if(!(2>g))if("-"==b.slice(0,1)&&isNaN(parseFloat(b)))p=b.slice(1);else{switch(p){case "b":f=
b;break;case "n":t=b}p="b"}});var m=function(b,g){var c=b||".";do{var e=h.join(c,"package.json");if(k.existsSync(e)){var a=require(e);if(g){if(a&&a.name==g)return e}else if(!a||"verup"!=a.name)return e}b=c;c=h.join(c,"..")}while(c!=b&&".."!=b.slice(0,2));return!1}(__dirname,t);m||n("package.json file not found",1);var u=h.dirname(m),a=require(m);a||n("Can't read package.json file",2);var d=a.extra&&a.extra.verup||a.verup;d||n("package.json doesn't have a `verup` property defined",3);var x=d.files;
d.regs&&(l=d.regs.map(function(b){return new RegExp(b,"i")}));if(d=a.version){f=f.split(".").reverse();for(var c=d.split(".").reverse(),v,q;f.length&&!(v=parseInt(f.pop())););q=f.length;c[q]=+c[q]+v;f.forEach(function(b,a){c[a]=b});c=c.reverse().join(".");a.version=c;console.log("Bumping version: "+d+" -> "+c);(a=JSON.stringify(a,null,2))&&d!=c&&k.writeFileSync(m,a+"\n");var w=function(b,a){return a+c};x.forEach(function(b){var a=h.join(u,b),d=k.readFileSync(a,"utf8"),e;switch(h.extname(b)){case ".json":try{var f=
JSON.parse(d);f.version=c;(e=JSON.stringify(f,null,2))&&(e+="\n")}catch(y){e=d.split("\n").map(function(a){return r.test(a)?a.replace(r,w):a}).join("\n")}break;default:e=d.split("\n").map(function(a){for(var b=l.length;b--;)if(l[b].test(a))return a.replace(l[b],w);return a}).join("\n")}e&&e!=d&&(console.log("\t"+a.replace(u,"").replace(/^[\\/]+/,"")),k.writeFileSync(a,e))})}})();
