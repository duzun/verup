#!/bin/env node
(function(){function n(b,k){process.stderr.write(b+"\n");process.exit(k)}function t(b,k){var c=b||".";do{var d=g.join(c,"package.json");if(h.existsSync(d)){g.isAbsolute(d)||(d=h.realpathSync(d));var a=require(d);if(k){if(a&&a.name==k)return d}else if(!a||"verup"!=a.name)return d}b=c;c=g.join(c,"..")}while(c!=b&&".."!=b.slice(0,2));return!1}var g=require("path"),h=require("fs"),l=[/^((?:\$|(?:\s*\**\s*@)|(?:\s*(?:var|,)?\s+))version[\s:='"]+)([0-9]+(?:\.[0-9]+){2,2})/i,/^(\s*const\s+VERSION[\s='"]+)([0-9]+(?:\.[0-9]+){2,2})/i,
/^(\s?\*.*v)([0-9]+(?:\.[0-9]+){2,2})/],u=/^(\s*['"]version['"]\s*:\s*['"])([0-9]+(?:\.[0-9]+){2,2})/i,f="1",p="",q="b";process.argv.forEach(function(b,c){if(!(2>c))if("-"==b.slice(0,1)&&isNaN(parseFloat(b)))q=b.slice(1);else{switch(q){case "b":f=b;break;case "n":p=b}q="b"}});var m=t(process.cwd(),p)||t(__dirname,p);m||n("package.json file not found",1);var v=g.dirname(m),a=require(m);a||n("Can't read package.json file",2);var e=a.extra&&a.extra.verup||a.verup;e||n("package.json doesn't have a `verup` property defined",
3);var y=e.files;e.regs&&(l=e.regs.map(function(b){return new RegExp(b,"i")}));if(e=a.version){f=f.split(".").reverse();for(var c=e.split(".").reverse(),w,r;f.length&&!(w=parseInt(f.pop())););r=f.length;c[r]=+c[r]+w;f.forEach(function(b,a){c[a]=b});c=c.reverse().join(".");a.version=c;console.log("Bumping version: "+e+" -> "+c);(a=JSON.stringify(a,null,2))&&e!=c&&h.writeFileSync(m,a+"\n");var x=function(b,a){return a+c};y.forEach(function(b){var a=g.join(v,b),e=h.readFileSync(a,"utf8"),d;switch(g.extname(b)){case ".json":try{var f=
JSON.parse(e);f.version=c;(d=JSON.stringify(f,null,2))&&(d+="\n")}catch(z){d=e.split("\n").map(function(a){return u.test(a)?a.replace(u,x):a}).join("\n")}break;default:d=e.split("\n").map(function(a){for(var b=l.length;b--;)if(l[b].test(a))return a.replace(l[b],x);return a}).join("\n")}d&&d!=e&&(console.log("\t"+a.replace(v,"").replace(/^[\\/]+/,"")),h.writeFileSync(a,d))})}})();
